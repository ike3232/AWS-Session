pipeline {
    agent any // Or specify a specific agent with 'agent { label 'your-agent-label' }'

    parameters {
        string(name: 'GIT_REPO_URL', defaultValue: 'https://github.com/your-org/your-repo.git', description: 'Git repository URL')
        string(name: 'GIT_BRANCH', defaultValue: 'main', description: 'Git branch to build')
        string(name: 'DOCKER_IMAGE_NAME', defaultValue: 'your-app-image', description: 'Name for the Docker image')
        string(name: 'DOCKER_CONTAINER_NAME', defaultValue: 'your-app-container', description: 'Name for the Docker container')
        string(name: 'DOCKER_PORT_MAPPING', defaultValue: '8080:8080', description: 'Port mapping for Docker container (host:container)')
    }

    stages {
        stage('Checkout Source Code') {
            steps {
                git branch: params.GIT_BRANCH, url: params.GIT_REPO_URL
            }
        }

        stage('Maven Build') {
            steps {
                sh 'mvn clean package -DskipTests' // Skips tests for faster build, remove if tests are required
            }
        }

        stage('Docker Build') {
            steps {
                script {
                    // Build the Docker image using the Dockerfile in the project root
                    docker.build("${params.DOCKER_IMAGE_NAME}:latest", "--pull .")
                }
            }
        }

        stage('Docker Run') {
            steps {
                script {
                    // Stop and remove existing container if it exists
                    sh "docker stop ${params.DOCKER_CONTAINER_NAME} || true"
                    sh "docker rm ${params.DOCKER_CONTAINER_NAME} || true"

                    // Run the new Docker container
                    docker.run("-d -p ${params.DOCKER_PORT_MAPPING} --name ${params.DOCKER_CONTAINER_NAME}", "${params.DOCKER_IMAGE_NAME}:latest")
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline finished.'
        }
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed!'
        }
    }
}
